# docker-compose.yml —— 只保留依赖服务

# 所有服务共享的默认配置
x-common: &common
  restart: unless-stopped
  env_file: .env
  init: true
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"

services:
  # PostgreSQL 数据库
  postgres:
    <<: *common
    image: postgres:16-alpine
    container_name: llm-postgres
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_HOST_AUTH_METHOD=scram-sha-256   # 指定使用 SCRAM-SHA-256 认证
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init/pg_hba.conf:/etc/postgresql/pg_hba.conf  # 挂载外部配置文件到容器
    command: ["postgres", "-c", "hba_file=/etc/postgresql/pg_hba.conf"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Redis 缓存 + Celery Broker
  redis:
    <<: *common
    image: redis:7.2.5-alpine
    container_name: llm-redis
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}  # 确保容器内有该变量
    command: sh -c 'exec redis-server --requirepass "$REDIS_PASSWORD" --tcp-keepalive 60'
    ports:
      - "6379:6379"
    volumes:
     - redis_data:/data
    healthcheck:
      test: >
        sh -c 'redis-cli -u redis://:$${REDIS_PASSWORD}@localhost:6379 ping || exit 1'
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s
      
  # MinIO 对象存储（兼容 S3）
  minio:
    <<: *common
    image: minio/minio:RELEASE.2025-05-24T17-08-30Z-cpuv1
    container_name: llm-minio
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"   # API
      - "9001:9001"   # Console
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/ready"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 60s

  # Qdrant 向量数据库
  qdrant:
    <<: *common
    # image: qdrant/qdrant:v1.14.0
    build: 
      context: .
      dockerfile: Dockerfile.qdrant
    container_name: llm-qdrant
    environment:
      - QDRANT__SERVICE__API_KEY=${QDRANT_API_KEY}  # 注入 API Key 给 Qdrant
    ports:
      - "6333:6333"   # API
      - "6334:6334"   # gRPC (可选)
    volumes:
      - qdrant_storage:/qdrant/storage
    healthcheck:
      test: ["CMD-SHELL", "curl -f -H 'api-key: ${QDRANT_API_KEY}' http://localhost:6333/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 90s

# 数据卷定义
volumes:
  postgres_data:
  minio_data:
  qdrant_storage:
  redis_data: